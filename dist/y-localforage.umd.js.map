{"version":3,"file":"y-localforage.umd.js","sources":["../src/y-localforage.ts"],"sourcesContent":["import * as Y         from 'yjs'\nimport { Observable } from 'lib0/observable'\n\n// Store Key Pattern: [<subdoc-guid>]@<timestamp>-<n>\n\n//namespace LocalForageProvider {\n  const GUIDPattern = /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}@/i\n\n  type SubDocChanges = {\n    added:Set<Y.Doc>, removed:Set<Y.Doc>, loaded:Set<Y.Doc>\n  }\n\n  export class LocalForageProvider extends Observable<any> {\n    private _Store:any\n    private _sharedDoc:Y.Doc\n    private _SuperProvider?:LocalForageProvider\n\n    private _isBusy:boolean  = false\n    private _UpdateLimit:number = 500\n\n    private _pendingUpdates:number   = 0\n    private _completedUpdates:number = 0\n\n    private _enqueuedUpdates:Uint8Array[] = []\n\n    private _SubDocMap:Map<Y.Doc,LocalForageProvider> = new Map()\n\n    constructor (\n      Store:any, sharedDoc:Y.Doc, UpdateLimit:number = 500,\n      SuperProvider?:LocalForageProvider\n    ) {\n      super()\n\n      this._Store         = Store\n      this._sharedDoc     = sharedDoc\n      this._SuperProvider = SuperProvider\n\n      this._isBusy      = false\n      this._UpdateLimit = UpdateLimit\n\n      this._storeUpdate = this._storeUpdate.bind(this)\n      sharedDoc.on('update', this._storeUpdate)\n\n      this._manageSubDocs = this._manageSubDocs.bind(this)\n      sharedDoc.on('subdocs', this._manageSubDocs)\n\n      this.destroy = this.destroy.bind(this)\n      sharedDoc.on('destroy', this.destroy)\n\n      this._applyStoredUpdates()     // is safe, even while updated or destroyed\n    }\n\n  /**** isSynced - is true while this provider and its sharedDoc are in-sync ****/\n\n    get isSynced ():boolean {\n      return (this._pendingUpdates === 0)\n    }\n\n  /**** isFullySynced - is true while this._sharedDoc and all subdocs are in-sync ****/\n\n    get isFullySynced ():boolean {\n      return (\n        (this._pendingUpdates === 0) &&\n        Array.from(this._SubDocMap.values()).every(\n          (SubProvider) => SubProvider.isSynced\n        )\n      )\n    }\n\n  /**** SubDocIsSynced - is true while the given SubDoc is in-sync ****/\n\n    public SubDocIsSynced (SubDoc:Y.Doc):boolean {\n      const SubDocProvider = this._SubDocMap.get(SubDoc)\n      return (SubDocProvider != null) && SubDocProvider.isSynced\n    }\n\n  /**** destroy - destroys persistence, invalidates provider ****/\n\n    async destroy ():Promise<void> {\n      if (this._Store == null) { return }         // provider has been destroyed\n\n      this._sharedDoc.off('update',  this._storeUpdate)\n      this._sharedDoc.off('subdocs', this._manageSubDocs)\n      this._sharedDoc.off('destroy', this.destroy)\n\n      if (! this.isSynced) {\n        this._pendingUpdates = 0\n        this.emit('sync-aborted',[this,1.0])\n      }\n\n      const KeysToDelete = (\n        this._SuperProvider == null\n        ? await this._StorageKeys()\n        : await this._StorageSubKeysFor(this._sharedDoc)\n      )\n\n      let Store = this._Store\n// @ts-ignore allow clearing of \"this._Store\"\n      this._Store = undefined\n\n      for (let i = 0, l = KeysToDelete.length; i < l; i++) {\n        await Store.removeItem(KeysToDelete[i])\n      }\n    }\n\n  /**** _applyStoredUpdates - applies all stored (incremental) updates to sharedDoc ****/\n\n    private async _applyStoredUpdates ():Promise<void> {\n      this._isBusy = true        // prevents update entries from being persisted\n        try {\n          this._pendingUpdates = 1 // very bad trick to keep this.isSynced false\n            const UpdateKeys = (\n              this._SuperProvider == null\n              ? await this._StorageKeys()\n              : await this._StorageSubKeysFor(this._sharedDoc)\n            )\n          this._pendingUpdates--                  // compensate trick from above\n\n          if (UpdateKeys.length > 0) {\n            this._pendingUpdates += UpdateKeys.length; this._reportProgress()\n\n            for (let i = 0, l = UpdateKeys.length; i < l; i++) {\n              if (this._Store == null) { return } // provider has been destroyed\n\n              const Update = await this._Store.getItem(UpdateKeys[i])\n              Y.applyUpdate(this._sharedDoc, Update, this)\n                                          // updates can be applied in any order\n              this._completedUpdates++; this._reportProgress()\n            }\n            this._sharedDoc.emit('load',[this])         // resolves \"whenLoaded\"\n          } else {\n            this._reportProgress()\n          }\n        } catch (Signal:any) {\n          this._breakdownWith(\n            'could not restore document from persistence', Signal\n          )\n        }\n      this._isBusy = false              // allows update entries to be persisted\n\n      if (this._enqueuedUpdates.length > 0) {\n        this._storeUpdatesAndCompact()\n      }\n    }\n\n  /**** _storeUpdate - stores a given (incremental) update ****/\n\n    private _storeUpdate (Update:Uint8Array, Origin?:any):void {\n      if (this._Store == null) { return }         // provider has been destroyed\n\n      if (Origin !== this) {          // ignore updates applied by this provider\n        this._pendingUpdates++; this._reportProgress()\n\n        this._enqueuedUpdates.push(Update)\n        if (! this._isBusy) {\n          this._storeUpdatesAndCompact()\n        }            // never write (and compact!) multiple updates concurrently\n      }\n    }\n\n  /**** _storeUpdatesAndCompact - stores enqueued updates and compacts ****/\n\n    private async _storeUpdatesAndCompact ():Promise<void> {\n      if (this._Store == null) { return }         // provider has been destroyed\n\n      this._isBusy = true\n        const UpdateKeys = (\n          this._SuperProvider == null\n          ? await this._StorageKeys()\n          : await this._StorageSubKeysFor(this._sharedDoc)\n        )\n\n        while ((this._Store != null) && (this._enqueuedUpdates.length > 0)) {\n          try {\n            await this._storeNextUpdateAmong(UpdateKeys)\n            if (this._Store == null) { return }   // provider has been destroyed\n          } catch (Signal) {\n            this._breakdownWith(\n              'could not persist document update', Signal\n            )\n          }\n\n          if (UpdateKeys.length >= this._UpdateLimit) {\n            try {\n              await this._compactUpdates(UpdateKeys)\n            } catch (Signal) {\n              this._breakdownWith(\n                'could not compact document updates', Signal\n              )\n            }\n          }\n        }\n      this._isBusy = false\n    }\n\n  /**** _storeNextUpdateAmong - stores next enqueued updates ****/\n\n    private async _storeNextUpdateAmong (UpdateKeys:string[]):Promise<void> {\n      let UpdateKey:string = this._newUpdateKeyAmong(UpdateKeys)\n      UpdateKeys.push(UpdateKey)\n\n      await this._Store.setItem(UpdateKey,this._enqueuedUpdates[0])\n\n      this._enqueuedUpdates.shift()\n      this._completedUpdates++; this._reportProgress()\n    }\n\n  /**** _compactUpdates - compacts the given list of updates ****/\n\n    private async _compactUpdates (UpdateKeys:string[]):Promise<void> {\n      const thisHadEnqueuedUpdates = (this._enqueuedUpdates.length > 0)\n        this._pendingUpdates -= this._enqueuedUpdates.length\n        this._enqueuedUpdates = []      // all enqueued updates will be included\n\n        let CompactKey:string = this._newUpdateKeyAmong(UpdateKeys)\n\n        await this._Store.setItem(CompactKey,Y.encodeStateAsUpdate(this._sharedDoc))\n        if (this._Store == null) { return }       // provider has been destroyed\n\n        for (let i = 0, l = UpdateKeys.length; i < l; i++) {\n          await this._Store.removeItem(UpdateKeys[i])\n          if (this._Store == null) { return }     // provider has been destroyed\n        }\n\n        UpdateKeys.splice(0,UpdateKeys.length, CompactKey)\n      if (thisHadEnqueuedUpdates) { this._reportProgress() }\n    }\n\n  /**** _newUpdateKeyAmong - generates a new unique update key ****/\n\n    private _newUpdateKeyAmong (UpdateKeys:string[]):string {\n      let KeyBase:string = (\n        (this._SuperProvider == null ? '' : this._sharedDoc.guid) + '@' + Date.now()\n      ), KeySuffix:number = 0\n        let UpdateKey:string = KeyBase + '-' + KeySuffix\n        while (UpdateKeys.indexOf(UpdateKey) >= 0) {\n          KeySuffix++\n          UpdateKey = KeyBase + '-' + KeySuffix\n        }\n      return UpdateKey\n    }\n\n  /**** _removeStoredSubDoc - removes a single stored subdoc ****/\n\n    private async _removeStoredSubDoc (SubDoc:Y.Doc):Promise<void> {\n      let KeysToDelete = await this._StorageSubKeysFor(SubDoc)\n      try {\n        for (let i = 0, l = KeysToDelete.length; i < l; i++) {\n          await this._Store.removeItem(KeysToDelete[i])\n          if (this._Store == null) { return }     // provider has been destroyed\n        }\n      } catch (Signal) {\n        this._breakdownWith(\n          'could not remove persistence for subdoc ' + SubDoc.guid, Signal\n        )\n      }\n    }\n\n  /**** _breakdown - breaks down this provider ****/\n\n    private _breakdown ():void {\n// @ts-ignore allow clearing of \"this._Store\"\n      this._Store = undefined\n\n      this._isBusy = false\n\n      if (! this.isSynced) {\n        this._enqueuedUpdates = []\n        this._pendingUpdates  = 0\n        this.emit('sync-aborted',[this,1.0])\n      }\n\n      this._SubDocMap.forEach((Provider) => Provider._breakdown())\n    }\n\n  /**** _breakdownWith - breaks down this provider after failure ****/\n\n    private _breakdownWith (Message:string, Reason?:any):never {\n      this._breakdown()\n\n      throw new Error(\n        Message + (Reason == null ? '' : ', reason: ' + Reason)\n      )\n    }\n\n  /**** _manageSubDocs - manages subdoc persistences ****/\n\n    private async _manageSubDocs (Changes:SubDocChanges):Promise<void> {\n      const providePersistenceFor = (SubDoc:Y.Doc) => {\n        if (\n          ! this._SubDocMap.has(SubDoc) &&\n          (this._sharedDoc.guid !== SubDoc.guid)     // \"doc copies\" are strange\n        ) {\n          const SubDocProvider = new LocalForageProvider(\n            this._Store, SubDoc, this._UpdateLimit, this\n          )\n          this._SubDocMap.set(SubDoc,SubDocProvider)\n        }\n      }\n\n      const { added, removed, loaded } = Changes\n\n      if (removed != null) {\n        let SubDocList:Y.Doc[] = Array.from(removed.values())\n        for (let i = 0, l = SubDocList.length; i < l; i++) {\n          const SubDoc = SubDocList[i]\n\n          const Provider = this._SubDocMap.get(SubDoc)\n          if (Provider != null) { Provider._breakdown() }\n\n          this._SubDocMap.delete(SubDoc)\n\n          if (\n            (this._sharedDoc != null) &&          // \"doc copies\" are strange...\n            (this._sharedDoc.guid !== SubDoc.guid) &&\n            Array.from(this._sharedDoc.getSubdocs().values()).every(\n              (existingSubDoc) => (existingSubDoc.guid !== SubDoc.guid)\n            )                                                       // ...really\n          ) {\n            await this._removeStoredSubDoc(SubDoc)\n          }  // warning: pot. race condition if \"guid\" is immediately used again\n        }\n      }\n\n      if (loaded != null) {\n        loaded.forEach((SubDoc:Y.Doc) => {\n          providePersistenceFor(SubDoc)\n        })\n      }\n    }\n\n  /**** _reportProgress - emits events reporting synchronization progress ****/\n\n    private _reportProgress ():void {\n      switch (true) {\n        case (this._pendingUpdates === 0):\n          this._completedUpdates = 0\n          this.emit('synced',[this])\n          this._sharedDoc.emit('sync',[this])     // resolves \"whenSynced\", once\n\n          if (this._SuperProvider != null) {\n            this._SuperProvider.emit('subdoc-synced',[this,this._sharedDoc])\n          }\n          break\n        case (this._completedUpdates === 0) && (this._pendingUpdates === 1):\n          this.emit('sync-started',[this,0.0])\n          break\n        case (this._completedUpdates === this._pendingUpdates):\n          this.emit('sync-finished',[this,1.0])\n\n          this._pendingUpdates = this._completedUpdates = 0\n          this.emit('synced',[this])\n          this._sharedDoc.emit('sync',[this])     // resolves \"whenSynced\", once\n\n          if (this._SuperProvider != null) {\n            this._SuperProvider.emit('subdoc-synced',[this,this._sharedDoc])\n          }\n          break\n        default:\n          const Progress = this._completedUpdates/this._pendingUpdates\n          this.emit('sync-continued',[this,Progress])\n      }\n    }\n\n  /**** _StorageKeys - lists all keys used for sharedDoc itself ****/\n\n    private async _StorageKeys ():Promise<string[]> {\n      let StoreKeys:string[] = await this._Store.keys()\n      return StoreKeys.filter((Key) => Key.startsWith('@'))\n    }\n\n  /**** _StorageSubKeys - lists all keys used for subdocs of sharedDoc ****/\n\n    private async _StorageSubKeys ():Promise<string[]> {\n      let StoreKeys:string[] = await this._Store.keys()\n      return StoreKeys.filter((Key) => ! Key.startsWith('@'))\n    }\n\n  /**** _StorageSubKeysFor - lists all keys used for a given subdoc ****/\n\n    private async _StorageSubKeysFor (SubDoc:Y.Doc):Promise<string[]> {\n      const KeyPrefix = SubDoc.guid + '@'\n\n      let StoreKeys:string[] = await this._Store.keys()\n      return StoreKeys.filter((Key) => Key.startsWith(KeyPrefix))\n    }\n  }\n//}\n"],"names":["_settle","pact","state","value","s","_Pact","o","bind","v","then","observer","prototype","onFulfilled","onRejected","result","this","callback","e","_this","_isSettledPact","thenable","_for","test","update","body","stage","shouldContinue","updateValue","_resumeAfterTest","_resumeAfterBody","_resumeAfterUpdate","reject","_Observable","LocalForageProvider","Store","sharedDoc","UpdateLimit","SuperProvider","call","_Store","_sharedDoc","_SuperProvider","_isBusy","_UpdateLimit","_pendingUpdates","_completedUpdates","_enqueuedUpdates","_SubDocMap","Map","_storeUpdate","_assertThisInitialized","on","_manageSubDocs","destroy","_applyStoredUpdates","_proto","SubDocIsSynced","SubDoc","SubDocProvider","get","isSynced","_this2","Promise","resolve","off","emit","_StorageKeys","_StorageSubKeysFor","KeysToDelete","undefined","i","l","length","_temp","removeItem","_exit","_temp5","_result","_this3","_storeUpdatesAndCompact","_temp4","_catch","UpdateKeys","_temp3","_result2","_reportProgress","_temp2","getItem","Update","Y","applyUpdate","Signal","_breakdownWith","Origin","push","_this4","_exit3","_temp11","_result5","_temp10","_temp9","_result4","_temp7","_temp6","_compactUpdates","_temp8","_storeNextUpdateAmong","_this5","UpdateKey","_newUpdateKeyAmong","setItem","shift","_this6","thisHadEnqueuedUpdates","CompactKey","encodeStateAsUpdate","_exit4","_temp13","_result6","splice","_temp12","KeyBase","guid","Date","now","KeySuffix","indexOf","_removeStoredSubDoc","_this7","_exit5","_breakdown","forEach","Provider","Message","Reason","Error","Changes","_temp16","loaded","providePersistenceFor","_this8","has","set","removed","_temp15","SubDocList","Array","from","values","_temp14","getSubdocs","every","existingSubDoc","keys","StoreKeys","filter","Key","startsWith","_StorageSubKeys","KeyPrefix","key","SubProvider","Observable"],"mappings":"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"}