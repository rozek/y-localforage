!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(require("yjs"),require("lib0/observable")):"function"==typeof define&&define.amd?define(["yjs","lib0/observable"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).Y,e.observable)}(this,(function(e,t){"use strict";function s(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(s){if("default"!==s){var i=Object.getOwnPropertyDescriptor(e,s);Object.defineProperty(t,s,i.get?i:{enumerable:!0,get:function(){return e[s]}})}})),t.default=e,Object.freeze(t)}var i,n=s(e);function d(e,t,s,i){return new(s||(s=Promise))((function(n,d){function o(e){try{h(i.next(e))}catch(e){d(e)}}function r(e){try{h(i.throw(e))}catch(e){d(e)}}function h(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}h((i=i.apply(e,t||[])).next())}))}!function(e){class s extends t.Observable{constructor(e,t,s=500){super(),this._isLoading=!1,this._UpdateLimit=500,this._pendingUpdates=0,this._completedUpdates=0,this._enqueuedUpdates=[],this._Store=e,this._sharedDoc=t,this._isLoading=!1,this._UpdateLimit=s,this._storeUpdate=this._storeUpdate.bind(this),t.on("update",this._storeUpdate),this.destroy=this.destroy.bind(this),t.on("destroy",this.destroy),this._applyStoredUpdates()}_applyStoredUpdates(){return d(this,void 0,void 0,(function*(){this._isLoading=!0;const e=yield this._Store.keys();if(e.length>0){this._pendingUpdates+=e.length,this._reportProgress();for(let t=0,s=e.length;t<s;t++){if(null==this._Store)return;const s=yield this._Store.getItem(e[t]);n.applyUpdate(this._sharedDoc,s),this._completedUpdates++,this._reportProgress()}}else this._reportProgress();this._isLoading=!1}))}_storeUpdate(e,t){null!=this._Store&&t!==this&&(this._pendingUpdates++,this._reportProgress(),this._enqueuedUpdates.push(e),1===this._enqueuedUpdates.length&&this._storeUpdatesAndCompact())}_storeUpdatesAndCompact(){return d(this,void 0,void 0,(function*(){if(null==this._Store)return;let e=yield this._Store.keys();for(;null!=this._Store&&this._enqueuedUpdates.length>0;){if(yield this._storeNextUpdateAmong(e),null==this._Store)return;e.length>=this._UpdateLimit&&!this._isLoading&&(yield this._compactUpdates(e))}}))}_storeNextUpdateAmong(e){return d(this,void 0,void 0,(function*(){let t=this._newUpdateKeyAmong(e);e.push(t),yield this._Store.setItem(t,this._enqueuedUpdates[0]),this._enqueuedUpdates.shift(),this._pendingUpdates--,this._reportProgress()}))}_compactUpdates(e){return d(this,void 0,void 0,(function*(){this._enqueuedUpdates.unshift(n.encodeStateAsUpdate(this._sharedDoc));const t=this._enqueuedUpdates.length>0;this._pendingUpdates-=this._enqueuedUpdates.length-1,this._enqueuedUpdates.splice(1);let s=this._newUpdateKeyAmong(e);if(e.unshift(s),yield this._Store.setItem(s,this._enqueuedUpdates[0]),null==this._Store)return;let i=e.splice(1);for(let e=0,t=i.length;e<t;e++)if(yield this._Store.removeItem(i[e]),null==this._Store)return;this._enqueuedUpdates.shift(),t&&this._reportProgress()}))}_newUpdateKeyAmong(e){let t=Date.now(),s=0,i=t+"-"+s;for(;e.indexOf(i)>=0;)s++,i=t+"-"+s;return i}destroy(){return d(this,void 0,void 0,(function*(){if(null==this._Store)return;let e=this._Store;this._Store=void 0,this._sharedDoc.off("update",this._storeUpdate),this._sharedDoc.off("destroy",this.destroy),this.isSynced||(this._pendingUpdates=0,this.emit("sync-aborted",[this,1]));let t=yield e.keys();for(let s=0,i=t.length;s<i;s++)yield e.removeItem(t[s])}))}get isSynced(){return 0===this._pendingUpdates}_reportProgress(){switch(!0){case 0===this._pendingUpdates:this._completedUpdates=0,this.emit("synced",[this]);break;case 0===this._completedUpdates:this.emit("sync-started",[this,0]);break;case this._completedUpdates===this._pendingUpdates:this.emit("sync-finished",[this,1]),this._pendingUpdates=this._completedUpdates=0,this.emit("synced",[this]);break;default:const e=this._completedUpdates/this._pendingUpdates;this.emit("sync-continued",[this,e])}}}e.LocalForageProvider=s}(i||(i={}))}));
//# sourceMappingURL=y-localforage.js.map
