!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(require("yjs"),require("lib0/observable")):"function"==typeof define&&define.amd?define(["yjs","lib0/observable"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).Y,t.observable)}(this,(function(t,e){"use strict";function s(t){if(t&&t.__esModule)return t;var e=Object.create(null);return t&&Object.keys(t).forEach((function(s){if("default"!==s){var i=Object.getOwnPropertyDescriptor(t,s);Object.defineProperty(e,s,i.get?i:{enumerable:!0,get:function(){return t[s]}})}})),e.default=t,Object.freeze(e)}var i,r=s(t);function o(t,e,s,i){return new(s||(s=Promise))((function(r,o){function d(t){try{h(i.next(t))}catch(t){o(t)}}function n(t){try{h(i.throw(t))}catch(t){o(t)}}function h(t){var e;t.done?r(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(d,n)}h((i=i.apply(t,e||[])).next())}))}!function(t){class s extends e.Observable{constructor(t,e,s=500,i){super(),this._isBusy=!1,this._UpdateLimit=500,this._pendingUpdates=0,this._completedUpdates=0,this._enqueuedUpdates=[],this._SubDocMap=new Map,this._Store=t,this._sharedDoc=e,this._SuperProvider=i,this._isBusy=!1,this._UpdateLimit=s,this._storeUpdate=this._storeUpdate.bind(this),e.on("update",this._storeUpdate),this._manageSubDocs=this._manageSubDocs.bind(this),e.on("subdocs",this._manageSubDocs),this.destroy=this.destroy.bind(this),e.on("destroy",this.destroy),this._applyStoredUpdates()}get isSynced(){return 0===this._pendingUpdates}get isFullySynced(){return 0===this._pendingUpdates&&Array.from(this._SubDocMap.values()).every((t=>t.isSynced))}SubDocIsSynced(t){const e=this._SubDocMap.get(t);return null!=e&&e.isSynced}destroy(){return o(this,void 0,void 0,(function*(){if(null==this._Store)return;let t=this._Store;this._Store=void 0,this._sharedDoc.off("update",this._storeUpdate),this._sharedDoc.off("subdocs",this._manageSubDocs),this._sharedDoc.off("destroy",this.destroy),this.isSynced||(this._pendingUpdates=0,this.emit("sync-aborted",[this,1]));const e=null==this._SuperProvider?yield this._StorageKeys():yield this._StorageSubKeysFor(this._sharedDoc);for(let s=0,i=e.length;s<i;s++)yield t.removeItem(e[s])}))}_applyStoredUpdates(){return o(this,void 0,void 0,(function*(){this._isBusy=!0;try{this._pendingUpdates=1;const t=null==this._SuperProvider?yield this._StorageKeys():yield this._StorageSubKeysFor(this._sharedDoc);if(this._pendingUpdates--,t.length>0){this._pendingUpdates+=t.length,this._reportProgress();for(let e=0,s=t.length;e<s;e++){if(null==this._Store)return;const s=yield this._Store.getItem(t[e]);r.applyUpdate(this._sharedDoc,s,this),this._completedUpdates++,this._reportProgress()}this._sharedDoc.emit("load",[this])}else this._reportProgress()}catch(t){this._breakdownWith("could not restore document from persistence",t)}this._isBusy=!1,this._enqueuedUpdates.length>0&&this._storeUpdatesAndCompact()}))}_storeUpdate(t,e){null!=this._Store&&e!==this&&(this._pendingUpdates++,this._reportProgress(),this._enqueuedUpdates.push(t),this._isBusy||this._storeUpdatesAndCompact())}_storeUpdatesAndCompact(){return o(this,void 0,void 0,(function*(){if(null==this._Store)return;this._isBusy=!0;const t=null==this._SuperProvider?yield this._StorageKeys():yield this._StorageSubKeysFor(this._sharedDoc);for(;null!=this._Store&&this._enqueuedUpdates.length>0;){try{if(yield this._storeNextUpdateAmong(t),null==this._Store)return}catch(t){this._breakdownWith("could not persist document update",t)}if(t.length>=this._UpdateLimit)try{yield this._compactUpdates(t)}catch(t){this._breakdownWith("could not compact document updates",t)}}this._isBusy=!1}))}_storeNextUpdateAmong(t){return o(this,void 0,void 0,(function*(){let e=this._newUpdateKeyAmong(t);t.push(e),yield this._Store.setItem(e,this._enqueuedUpdates[0]),this._enqueuedUpdates.shift(),this._completedUpdates++,this._reportProgress()}))}_compactUpdates(t){return o(this,void 0,void 0,(function*(){const e=this._enqueuedUpdates.length>0;this._pendingUpdates-=this._enqueuedUpdates.length,this._enqueuedUpdates=[];let s=this._newUpdateKeyAmong(t);if(yield this._Store.setItem(s,r.encodeStateAsUpdate(this._sharedDoc)),null!=this._Store){for(let e=0,s=t.length;e<s;e++)if(yield this._Store.removeItem(t[e]),null==this._Store)return;t.splice(0,t.length,s),e&&this._reportProgress()}}))}_newUpdateKeyAmong(t){let e=(null==this._SuperProvider?"":this._sharedDoc.guid)+"@"+Date.now(),s=0,i=e+"-"+s;for(;t.indexOf(i)>=0;)s++,i=e+"-"+s;return i}_removeStoredSubDoc(t){return o(this,void 0,void 0,(function*(){let e=yield this._StorageSubKeysFor(t);try{for(let t=0,s=e.length;t<s;t++)if(yield this._Store.removeItem(e[t]),null==this._Store)return}catch(e){this._breakdownWith("could not remove persistence for subdoc "+t.guid,e)}}))}_breakdown(){this._Store=void 0,this._isBusy=!1,this.isSynced||(this._enqueuedUpdates=[],this._pendingUpdates=0,this.emit("sync-aborted",[this,1])),this._SubDocMap.forEach((t=>t._breakdown()))}_breakdownWith(t,e){throw this._breakdown(),new Error(t+(null==e?"":", reason: "+e))}_manageSubDocs(t){return o(this,void 0,void 0,(function*(){const e=t=>{if(!this._SubDocMap.has(t)&&this._sharedDoc.guid!==t.guid){const e=new s(this._Store,t,this._UpdateLimit,this);this._SubDocMap.set(t,e)}},{added:i,removed:r,loaded:o}=t;if(null!=r){let t=Array.from(r.values());for(let e=0,s=t.length;e<s;e++){const s=t[e],i=this._SubDocMap.get(s);null!=i&&i._breakdown(),this._SubDocMap.delete(s),null!=this._sharedDoc&&this._sharedDoc.guid!==s.guid&&Array.from(this._sharedDoc.getSubdocs().values()).every((t=>t.guid!==s.guid))&&(yield this._removeStoredSubDoc(s))}}null!=o&&o.forEach((t=>{e(t)}))}))}_reportProgress(){switch(!0){case 0===this._pendingUpdates:this._completedUpdates=0,this.emit("synced",[this]),this._sharedDoc.emit("sync",[this]),null!=this._SuperProvider&&this._SuperProvider.emit("subdoc-synced",[this,this._sharedDoc]);break;case 0===this._completedUpdates&&1===this._pendingUpdates:this.emit("sync-started",[this,0]);break;case this._completedUpdates===this._pendingUpdates:this.emit("sync-finished",[this,1]),this._pendingUpdates=this._completedUpdates=0,this.emit("synced",[this]),this._sharedDoc.emit("sync",[this]),null!=this._SuperProvider&&this._SuperProvider.emit("subdoc-synced",[this,this._sharedDoc]);break;default:const t=this._completedUpdates/this._pendingUpdates;this.emit("sync-continued",[this,t])}}_StorageKeys(){return o(this,void 0,void 0,(function*(){return(yield this._Store.keys()).filter((t=>t.startsWith("@")))}))}_StorageSubKeys(){return o(this,void 0,void 0,(function*(){return(yield this._Store.keys()).filter((t=>!t.startsWith("@")))}))}_StorageSubKeysFor(t){return o(this,void 0,void 0,(function*(){const e=t.guid+"@";return(yield this._Store.keys()).filter((t=>t.startsWith(e)))}))}}t.LocalForageProvider=s}(i||(i={}))}));
//# sourceMappingURL=y-localforage.js.map
